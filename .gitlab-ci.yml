stages:
  - build
  - test  
  - deploy

cache:
  paths:
    - frontend/node_modules/
    - backend/vendor

build:
  stage : build
  script:
    - cd frontend
    - rm -rf .env.production    
    - cp .env.production.example .env.production  
    - npm run build    
    - cd ..
    - ssh -p $SSH_PORT $SSH_USERNAME@$SSH_HOST "mkdir -p $SSH_PATH/campus50_temp"
    - rsync -arvz -e "ssh -p $SSH_PORT" --progress frontend/dist/ $SSH_USERNAME@$SSH_HOST:$SSH_PATH/campus50_temp    
    - ssh -p $SSH_PORT $SSH_USERNAME@$SSH_HOST "mv $SSH_PATH/campus50 $SSH_PATH/siakad_old && mv $SSH_PATH/campus50_temp $SSH_PATH/campus50"
    - ssh -p $SSH_PORT $SSH_USERNAME@$SSH_HOST "rm -rf $SSH_PATH/campus50_old"    
    - rsync -arvz -e "ssh -p $SSH_PORT" --progress backend/app $SSH_USERNAME@$SSH_HOST:$SSH_PATH/api/app
    - rsync -arvz -e "ssh -p $SSH_PORT" --progress backend/database $SSH_USERNAME@$SSH_HOST:$SSH_PATH/api/database
    - rsync -arvz -e "ssh -p $SSH_PORT" --progress backend/routes $SSH_USERNAME@$SSH_HOST:$SSH_PATH/api/routes    
    - rsync -arvz -e "ssh -p $SSH_PORT" --progress backend/.env.example $SSH_USERNAME@$SSH_HOST:$SSH_PATH/api       
    
    
test:
  stage: test
  script:
    - echo "Ini tahap testing"
    - cd frontend    
    - cd ..

deploy:
  stage : deploy
  artifacts:
    paths:
      - frontend/dist
  only :
    - master
  script:    
    - cd frontend
    - rm -rf .env.production    
    - cp .env.production.example .env.production  
    - npm run build    
    - cd ..
    - ssh -p $SSH_PORT $SSH_USERNAME@$SSH_HOST "mkdir -p $SSH_PATH/campus50_temp"
    - rsync -arvz -e "ssh -p $SSH_PORT" --progress frontend/dist/ $SSH_USERNAME@$SSH_HOST:$SSH_PATH/campus50_temp    
    - ssh -p $SSH_PORT $SSH_USERNAME@$SSH_HOST "mv $SSH_PATH/campus50 $SSH_PATH/siakad_old && mv $SSH_PATH/campus50_temp $SSH_PATH/campus50"
    - ssh -p $SSH_PORT $SSH_USERNAME@$SSH_HOST "rm -rf $SSH_PATH/campus50_old"    
    - rsync -arvz -e "ssh -p $SSH_PORT" --progress backend/app $SSH_USERNAME@$SSH_HOST:$SSH_PATH/api/app
    - rsync -arvz -e "ssh -p $SSH_PORT" --progress backend/database $SSH_USERNAME@$SSH_HOST:$SSH_PATH/api/database
    - rsync -arvz -e "ssh -p $SSH_PORT" --progress backend/routes $SSH_USERNAME@$SSH_HOST:$SSH_PATH/api/routes    
    - rsync -arvz -e "ssh -p $SSH_PORT" --progress backend/.env.example $SSH_USERNAME@$SSH_HOST:$SSH_PATH/api    
